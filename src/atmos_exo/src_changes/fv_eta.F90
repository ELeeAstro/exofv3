module fv_eta_mod
 use constants_mod,  only: kappa, grav, cp_air, rdgas
 use fv_mp_mod,      only: gid
  use mpp_mod,             only: FATAL, mpp_error, mpp_pe, stdlog, &
                                 mpp_npes, mpp_get_current_pelist, get_unit
 implicit none
 private
 public set_eta, get_eta_level, compute_dz_L32, set_hybrid_z, compute_dz, gw_1d

 namelist /fv_eta_nml/ uniform_z_spacing, uniform_z_factor, flexible_grid, &
                       pbot, pup, plin

      logical :: uniform_z_spacing = .false.
      real :: uniform_z_factor = 8.0

      ! Parameters for Elsie Lee's sigma grid generator
      logical :: flexible_grid = .false. ! Switch
      real    :: pbot = 220.e5           ! Bottom boundary pressure
      real    :: pup  = 5.e-2            ! Upper boundary pressure
      real    :: plin = 1.e1             ! Where linear spacing of levels starts
      
 contains

 subroutine set_eta(km, uniform_vert_spacing, ks, ptop, ak, bk)

      integer,  intent(in) :: km                   ! vertical dimension
      logical,  intent(in) :: uniform_vert_spacing ! uniform vertical spacing for any km
      integer,  intent(out):: ks                   ! number of pure p layers
      real, intent(out):: ak(km+1)
      real, intent(out):: bk(km+1)
      real, intent(out):: ptop         ! model top (Pa)
! local
      real a24(25),b24(25)            ! GFDL AM2L24
      real a26(27),b26(27)            ! Jablonowski & Williamson 26-level
      real a32(33),b32(33)
      real a32w(33),b32w(33)
      real a47(48),b47(48)
      real a48(49),b48(49)
      real a52(53),b52(53)            ! 220 bar to 1e-6 bar 53 level system, but has been tested up to 1000 bar
      real a54(55),b54(55)            ! 1000 bar to 1e-6 bar 55 level system
      real a54_new(55),b54_new(55)
      real a55(56),b55(56)
      real a56(57),b56(57)            ! For Mars GCM
      real a60(61),b60(61)
      real a64(65),b64(65)
      real a100(101),b100(101)
      real a104(105),b104(105)
#if defined(HOT_JUPITER)
      real a50(51), b50(51)
      real:: p0=1000.E4
      real:: pc=1.E4
#else
      real:: p0=1000.E2
      real:: pc=200.E2
#endif

      real pt, pint, lnpe, dlnp
      real press(km+1), pt1(km)
      integer  k


    integer :: f_unit, unit, ios ! Namelist reading
    character(80) :: filename

    filename = "input.nml"


       f_unit = get_unit()
       open (f_unit,file=filename)
       rewind (f_unit)
       read (f_unit,fv_eta_nml ,iostat=ios)
       unit = stdlog()
       write(unit, nml=fv_eta_nml)

       close(f_unit)

! Definition: press(i,j,k) = ak(k) + bk(k) * ps(i,j)

!-----------------------------------------------
! GFDL AM2-L24: modified by SJL at the model top
!-----------------------------------------------
!     data a24 /  100.0000,  1050.0000,  3474.7942,  7505.5556, 12787.2428,   &
      data a24 /  100.0000,   903.4465,  3474.7942,  7505.5556, 12787.2428,   &
                19111.3683, 21854.9274, 22884.1866, 22776.3058, 21716.1604,   &
                20073.2963, 18110.5123, 16004.7832, 13877.6253, 11812.5452,   &
                 9865.8840,  8073.9726,  6458.0834,  5027.9899,  3784.6085,   &
                 2722.0086,  1828.9752,  1090.2396,   487.4595,     0.0000    /

      data b24 / 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000,       &
                 0.0000000, 0.0435679, 0.1102275, 0.1922249, 0.2817656,       &
                 0.3694997, 0.4532348, 0.5316253, 0.6038733, 0.6695556,       &
                 0.7285176, 0.7808017, 0.8265992, 0.8662148, 0.9000406,       &
                 0.9285364, 0.9522140, 0.9716252, 0.9873523, 1.0000000        /

! Jablonowski & Williamson 26-level setup
      data a26 /  219.4067,   489.5209,   988.2418,  1805.2010,  2983.7240,  4462.3340,   &
                 6160.5870,  7851.2430,  7731.2710,  7590.1310,  7424.0860,   &
                 7228.7440,  6998.9330,  6728.5740,  6410.5090,  6036.3220,   &
                 5596.1110,  5078.2250,  4468.9600,  3752.1910,  2908.9490,   &
                  2084.739,   1334.443,    708.499,   252.1360,  0.0, 0.0     /

      data b26 / 0.0, 0.0, 0.0000000, 0.0000000, 0.0000000, 0.0000000, 0.0000000,&
                 0.0000000, 0.01505309, 0.03276228, 0.05359622, 0.07810627,      &
                 0.1069411, 0.1408637, 0.1807720, 0.2277220, 0.2829562,       &
                 0.3479364, 0.4243822, 0.5143168, 0.6201202, 0.7235355,       &
                 0.8176768, 0.8962153, 0.9534761, 0.9851122, 1.0000000        /


! High-resolution troposphere setup
! Revised Apr 14, 2004: PINT = 245.027 mb
      data a32/100.00000,     400.00000,     818.60211, &
              1378.88653,    2091.79519,    2983.64084, &
              4121.78960,    5579.22148,    7419.79300, &
              9704.82578,   12496.33710,   15855.26306, &
             19839.62499,   24502.73262,   28177.10152, &
             29525.28447,   29016.34358,   27131.32792, &
             24406.11225,   21326.04907,   18221.18357, &
             15275.14642,   12581.67796,   10181.42843, &
              8081.89816,    6270.86956,    4725.35001, &
              3417.39199,    2317.75459,    1398.09473, &
               632.49506,       0.00000,       0.00000  /

      data b32/0.00000,       0.00000,       0.00000, &
               0.00000,       0.00000,       0.00000, &
               0.00000,       0.00000,       0.00000, &
               0.00000,       0.00000,       0.00000, &
               0.00000,       0.00000,       0.01711, &
               0.06479,       0.13730,       0.22693, &
               0.32416,       0.42058,       0.51105, &
               0.59325,       0.66628,       0.73011, &
               0.78516,       0.83217,       0.87197, &
               0.90546,       0.93349,       0.95685, &
               0.97624,       0.99223,       1.00000  /

!---------------------
! Wilson's 32L settings:
!---------------------
! Top changed to 0.01 mb
      data a32w/  1.00,       26.6378,     84.5529,     228.8592,   & 
                539.9597,   1131.7087,   2141.8082,    3712.0454,   &
               5963.5317,   8974.1873,  12764.5388,   17294.5911,   &
              20857.7007,  22221.8651,  22892.7202,   22891.1641,   &
              22286.0724,  21176.0846,  19673.0671,   17889.0989,   &
              15927.5060,  13877.6239,  11812.5474,    9865.8830,   &
               8073.9717,   6458.0824,   5027.9893,    3784.6104,   &
               2722.0093,   1828.9741,   1090.2397,     487.4575,   &
               0.0000 /
         
      data b32w/ 0.0000,   0.0000,   0.0000,   0.0000,       &
                0.0000,   0.0000,   0.0000,    0.0000,       &
                0.0000,   0.0000,   0.0000,    0.0000,       &
                0.0159,   0.0586,   0.1117,    0.1734,       &
                0.2415,   0.3137,   0.3878,    0.4619,       &
                0.5344,   0.6039,   0.6696,    0.7285,       &
                0.7808,   0.8266,   0.8662,    0.9000,       &
                0.9285,   0.9522,   0.9716,    0.9874,       &
                1.0000 /


! QBO setting with ptop = 0.1 mb and p_full=0.17 mb
      data a47/   10.00000,      24.45365,      48.76776,  &
                  85.39458,     133.41983,     191.01402,  &
                 257.94919,     336.63306,     431.52741,  &
                 548.18995,     692.78825,     872.16512,  &
                1094.18467,    1368.11917,    1704.99489,  &
                2117.91945,    2622.42986,    3236.88281,  &
                3982.89623,    4885.84733,    5975.43260,  &
                7286.29500,    8858.72424,   10739.43477,  &
               12982.41110,   15649.68745,   18811.37629,  &
               22542.71275,   25724.93857,   27314.36781,  &
               27498.59474,   26501.79312,   24605.92991,  &
               22130.51655,   19381.30274,   16601.56419,  &
               13952.53231,   11522.93244,    9350.82303,  &
                7443.47723,    5790.77434,    4373.32696,  &
                3167.47008,    2148.51663,    1293.15510,  &
                 581.62429,       0.00000,       0.00000   /

      data b47/ 0.0000,        0.0000,        0.0000,      &
                0.00000,       0.00000,       0.00000,     &
                0.00000,       0.00000,       0.00000,     &
                0.00000,       0.00000,       0.00000,     &
                0.00000,       0.00000,       0.00000,     &
                0.00000,       0.00000,       0.00000,     &
                0.00000,       0.00000,       0.00000,     &
                0.00000,       0.00000,       0.00000,     &
                0.00000,       0.00000,       0.00000,     &
                0.00000,       0.01188,       0.04650,     &
                0.10170,       0.17401,       0.25832,     &
                0.34850,       0.43872,       0.52448,     &
                0.60307,       0.67328,       0.73492,     &
                0.78834,       0.83418,       0.87320,     &
                0.90622,       0.93399,       0.95723,     &
                0.97650,       0.99223,       1.00000   /

#ifdef HI_48
! High trop-resolution (Feb 2004)
      data a48/40.00000,     100.00000,     200.00000,     &
              350.00000,     550.00000,     800.00000,     &
             1085.00000,    1390.00000,    1720.00000,     &
             2080.00000,    2470.00000,    2895.00000,     &
             3365.00000,    3890.00000,    4475.00000,     &
             5120.00000,    5830.00000,    6608.00000,     &
             7461.00000,    8395.00000,    9424.46289,     &
            10574.46900,   11864.80330,   13312.58850,     &
            14937.03770,   16759.70760,   18804.78670,     &
            21099.41250,   23674.03720,   26562.82650,     &
            29804.11680,   32627.31601,   34245.89759,     &
            34722.29104,   34155.20062,   32636.50533,     &
            30241.08406,   27101.45052,   23362.20912,     &
            19317.04955,   15446.17194,   12197.45091,     &
             9496.39912,    7205.66920,    5144.64339,     &
             3240.79521,    1518.62245,       0.00000,     &
                0.00000  /

      data b48/0.00000,       0.00000,       0.00000,      &
               0.00000,       0.00000,       0.00000,      &
               0.00000,       0.00000,       0.00000,      &
               0.00000,       0.00000,       0.00000,      &
               0.00000,       0.00000,       0.00000,      &
               0.00000,       0.00000,       0.00000,      &
               0.00000,       0.00000,       0.00000,      &
               0.00000,       0.00000,       0.00000,      &
               0.00000,       0.00000,       0.00000,      &
               0.00000,       0.00000,       0.00000,      &
               0.00000,       0.00813,       0.03224,      &
               0.07128,       0.12445,       0.19063,      &
               0.26929,       0.35799,       0.45438,      &
               0.55263,       0.64304,       0.71703,      &
               0.77754,       0.82827,       0.87352,      &
               0.91502,       0.95235,       0.98511,      &
               1.00000      /
#else
           data a48/                                &
                   1.00000,       2.69722,       5.17136,   &
                   8.89455,      14.24790,      22.07157,   &
                  33.61283,      50.48096,      74.79993,   &
                 109.40055,     158.00460,     225.44108,   &
                 317.89560,     443.19350,     611.11558,   &
                 833.74392,    1125.83405,    1505.20759,   &
                1993.15829,    2614.86254,    3399.78420,   &
                4382.06240,    5600.87014,    7100.73115,   &
                8931.78242,   11149.97021,   13817.16841,   &
               17001.20930,   20775.81856,   23967.33875,   &
               25527.64563,   25671.22552,   24609.29622,   &
               22640.51220,   20147.13482,   17477.63530,   &
               14859.86462,   12414.92533,   10201.44191,   &
                8241.50255,    6534.43202,    5066.17865,   &
                3815.60705,    2758.60264,    1870.64631,   &
                1128.33931,     510.47983,       0.00000,   &
                   0.00000  /

           data b48/              &
                   0.00000,       0.00000,       0.00000,   &
                   0.00000,       0.00000,       0.00000,   &
                   0.00000,       0.00000,       0.00000,   &
                   0.00000,       0.00000,       0.00000,   &
                   0.00000,       0.00000,       0.00000,   &
                   0.00000,       0.00000,       0.00000,   &
                   0.00000,       0.00000,       0.00000,   &
                   0.00000,       0.00000,       0.00000,   &
                   0.00000,       0.00000,       0.00000,   &
                   0.00000,       0.00000,       0.01253,   &
                   0.04887,       0.10724,       0.18455,   &
                   0.27461,       0.36914,       0.46103,   &
                   0.54623,       0.62305,       0.69099,   &
                   0.75016,       0.80110,       0.84453,   &
                   0.88127,       0.91217,       0.93803,   &
                   0.95958,       0.97747,       0.99223,   &
                   1.00000   /
#endif

#ifdef TTT
      data a52/10.00000,      28.03821,      47.30985,
               73.04316,     104.06818,     138.87408,
              176.68177,     217.95192,     264.18103,
              317.38922,     379.72218,     453.32332,
              540.40931,     643.41528,     765.12346,
              908.75865,    1078.06815,    1277.40350,
             1511.81203,    1787.14119,    2110.15735,
             2488.68103,    2931.74058,    3449.74671,
             4054.69027,    4760.36642,    5582.62804,
             6539.67222,    7652.36351,    8944.59841,
            10443.71572,   12180.95818,   14191.99107,
            16517.48428,   19203.76464,   22303.54062,
            25055.65282,   26711.91307,   27331.21218,
            26954.08613,   25620.43358,   23404.71758,
            20462.02531,   17054.81751,   13523.60500,
            10200.47371,    7317.24740,    4967.87694,
             3135.41449,    1747.40389,     722.93629,
                0.00000,       0.00000 /


      data b52 /0.00000,       0.00000,       0.00000,     &
                0.00000,       0.00000,       0.00000,
                0.00000,       0.00000,       0.00000,
                0.00000,       0.00000,       0.00000,
                0.00000,       0.00000,       0.00000,
                0.00000,       0.00000,       0.00000,
                0.00000,       0.00000,       0.00000,
                0.00000,       0.00000,       0.00000,
                0.00000,       0.00000,       0.00000,
                0.00000,       0.00000,       0.00000,
                0.00000,       0.00000,       0.00000,
                0.00000,       0.00000,       0.00000,
                0.00821,       0.03278,       0.07386,
                0.13169,       0.20624,       0.29626,
                0.39833,       0.50628,       0.61217,
                0.70842,       0.79008,       0.85568,
                0.90635,       0.94448,       0.97251,
                0.99223,       1.00000 /
#endif

#ifdef HOT_JUPITER
 data b50 / &
       1.00000000e-08, 1.44543977e-08, 2.08929613e-08, 3.01995172e-08,&
       4.36515832e-08, 6.30957344e-08, 9.12010839e-08, 1.31825674e-07,&
       1.90546072e-07, 2.75422870e-07, 3.98107171e-07, 5.75439937e-07,&
       8.31763771e-07, 1.20226443e-06, 1.73780083e-06, 2.51188643e-06,&
       3.63078055e-06, 5.24807460e-06, 7.58577575e-06, 1.09647820e-05,&
       1.58489319e-05, 2.29086765e-05, 3.31131121e-05, 4.78630092e-05,&
       6.91830971e-05, 1.00000000e-04, 1.44543977e-04, 2.08929613e-04,&
       3.01995172e-04, 4.36515832e-04, 6.30957344e-04, 9.12010839e-04,&
       1.31825674e-03, 1.90546072e-03, 2.75422870e-03, 3.98107171e-03,&
       5.75439937e-03, 8.31763771e-03, 1.20226443e-02, 1.73780083e-02,&
       2.51188643e-02, 3.63078055e-02, 5.24807460e-02, 7.58577575e-02,&
       1.09647820e-01, 1.58489319e-01, 2.29086765e-01, 3.31131121e-01,&
       4.78630092e-01, 6.91830971e-01, 1.00000000e+00 /
data a50  / &
       1.00000000e+01, 1.20226443e+01, 1.44543977e+01, 1.73780083e+01,&
       2.08929613e+01, 2.51188643e+01, 3.01995172e+01, 3.63078055e+01,&
       4.36515832e+01, 5.24807460e+01, 6.30957344e+01, 7.58577575e+01,&
       9.12010839e+01, 1.09647820e+02, 1.31825674e+02, 1.58489319e+02,&
       1.90546072e+02, 2.29086765e+02, 2.75422870e+02, 3.31131121e+02,&
       3.98107171e+02, 4.78630092e+02, 5.75439937e+02, 6.91830971e+02,&
       8.31763771e+02, 1.00000000e+03, 1.20226443e+03, 1.44543977e+03,&
       1.73780083e+03, 2.08929613e+03, 2.51188643e+03, 3.01995172e+03,&
       3.63078055e+03, 4.36515832e+03, 5.24807460e+03, 6.30957344e+03,&
       7.58577575e+03, 9.12010839e+03, 1.09647820e+04, 1.31825674e+04,&
       1.58489319e+04, 1.90546072e+04, 2.29086765e+04, 2.75422870e+04,&
       3.31131121e+04, 3.98107171e+04, 4.78630092e+04, 5.75439937e+04,&
       6.91830971e+04, 8.31763771e+04, 0.00000000e+00 /
#endif HOT_JUPITER

data b52 / &
2.2727272727272727e-09, 3.3324801199555632e-09, 4.886386449955581e-09,&
7.164865709274777e-09, 1.0505779916856185e-08, 1.5404533195722723e-08,&
2.2587532278054278e-08, 3.311990100120702e-08, 4.8563421131024246e-08,&
7.120811960951402e-08, 1.044118429103743e-07, 1.5309817194616815e-07,&
2.244865103413433e-07, 3.2916260648071946e-07, 4.826482506250917e-07,&
7.077029080613574e-07, 1.0376985836576538e-06, 1.5215683562398778e-06,&
2.231062371262057e-06, 3.2713872393891584e-06, 4.7968064935739005e-06,&
7.033515402807869e-06, 1.0313182111433727e-05, 1.5122128718327065e-05,&
2.2173445063102982e-05, 3.251272854003574e-05, 4.767312946227964e-05,&
6.99026927232105e-05, 0.00010249770688584301, 0.00015029149103676587,&
0.00022037109867454092, 0.0003231282143520963, 0.0004738000742310444,&
0.0006947289044117072, 0.0010186749155926304, 0.001493674118160335,&
0.0021901612939630483, 0.0032114143475163253, 0.004708868766816817,&
0.006904573083274554, 0.010124115116188805, 0.014844901437009984,&
0.02176694912547564, 0.031916687102401954, 0.04679915911598253,&
0.06862119764924554, 0.10061866186840697, 0.14753626376411874,&
0.21633113302523627, 0.31720444805898806, 0.4651141075319441,&
0.6819927474188744, 1.000000000000000 /
data a52 / &
0.05, 0.24134615384615382, 0.43269230769230765, &
0.6240384615384615,0.8153846153846154,1.0067307692307692, &
1.198076923076923, 1.3894230769230769, 1.5807692307692307, &
1.7721153846153845, 1.9634615384615384, 2.154807692307692, &
2.346153846153846, 2.5374999999999996, 2.7288461538461535, &
2.9201923076923073, 3.111538461538461, 3.302884615384615, &
3.494230769230769, 3.6855769230769226, 3.8769230769230765, &
4.06826923076923, 4.259615384615384, 4.450961538461538, &
4.642307692307692, 4.833653846153846, 5.0249999999999995, &
5.216346153846153, 5.407692307692307, 5.599038461538461, &
5.790384615384615, 5.981730769230769, 6.1730769230769225, &
6.364423076923076, 6.55576923076923, 6.747115384615384, &
6.938461538461538, 7.129807692307692, 7.3211538461538455, &
7.512499999999999, 7.703846153846153, 7.895192307692307, &
8.086538461538462, 8.277884615384615, 8.46923076923077, &
8.660576923076924, 8.851923076923077, 9.04326923076923, &
9.234615384615385, 9.42596153846154, 9.617307692307692, &
9.808653846153845, 0.0e0 /

! High PBL resolution with top at 1 mb
      data a54/100.00000,     254.83931,     729.54278,   &
              1602.41121,    2797.50667,    4100.18977,   &
              5334.87140,    6455.24153,    7511.80944,   &
              8580.26355,    9714.44293,   10938.62253,   &
             12260.23793,   13681.38045,   15202.98892,   &
             16825.44410,   18548.56604,   20371.61864,   &
             22293.32079,   24033.35009,   25351.40415,   &
             26299.18673,   26920.83214,   27254.25434,   &
             27332.23371,   27183.29496,   26832.41840,   &
             26301.61755,   25610.40943,   24776.19833,   &
             23814.58975,   22739.64777,   21564.10661,   &
             20299.54484,   18956.61643,   17545.95425,   &
             16081.13773,   14583.85910,   13086.91505,   &
             11629.08518,   10243.59383,    8949.94267,   &
              7754.77820,    6657.52188,    5654.67945,   &
              4741.55941,    3912.82209,    3162.77710,   &
              2485.60664,    1875.52987,    1326.92552,   &
               834.46138,     393.36354,       0.00000,   &
                 0.00000 /

      data b54/0.00000,       0.00000,       0.00000,  &
               0.00000,       0.00000,       0.00000,  &
               0.00000,       0.00000,       0.00000,  &
               0.00000,       0.00000,       0.00000,  &
               0.00000,       0.00000,       0.00000,  &
               0.00000,       0.00000,       0.00000,  &
               0.00000,       0.00279,       0.01074,  &
               0.02331,       0.04002,       0.06047,  &
               0.08428,       0.11112,       0.14071,  &
               0.17276,       0.20703,       0.24330,  &
               0.28136,       0.32101,       0.36207,  &
               0.40437,       0.44775,       0.49201,  &
               0.53690,       0.58187,       0.62608,  &
               0.66854,       0.70844,       0.74534,  &
               0.77916,       0.81002,       0.83807,  &
               0.86349,       0.88647,       0.90721,  &
               0.92587,       0.94265,       0.95770,  &
               0.97119,       0.98326,       0.99400,  &
               1.00000   /
      
      data a54_new/0.05,               0.23425925925925922, 0.41851851851851846,  &
                   0.6027777777777777, 0.787037037037037  , 0.9712962962962962 ,  &
                   1.1555555555555554, 1.3398148148148146 , 1.524074074074074  ,  &
                   1.7083333333333333, 1.8925925925925924 , 2.0768518518518513 ,  &
                   2.2611111111111106, 2.44537037037037   , 2.629629629629629  ,  &
                   2.813888888888888 , 2.9981481481481476 , 3.182407407407407  ,  &
                   3.3666666666666663, 3.550925925925925  , 3.7351851851851845 ,  &
                   3.919444444444444 , 4.103703703703703  , 4.287962962962962  ,  &
                   4.472222222222221 , 4.656481481481481  , 4.84074074074074   ,  &
                   5.0249999999999995, 5.209259259259258  , 5.393518518518517  ,  &
                   5.577777777777777 , 5.762037037037036  , 5.946296296296295  ,  &
                   6.130555555555555 , 6.314814814814814  , 6.499074074074073  ,  &
                   6.683333333333333 , 6.867592592592591  , 7.0518518518518505 ,  &
                   7.23611111111111  , 7.420370370370369  , 7.6046296296296285 ,  &
                   7.788888888888888 , 7.973148148148147  , 8.157407407407407  ,  &
                   8.341666666666667 , 8.525925925925925  , 8.710185185185185  ,  &
                   8.894444444444444 , 9.078703703703702  , 9.262962962962963  ,  &
                   9.447222222222221 , 9.631481481481481  , 9.81574074074074   ,  &
                   0.0   /

      data b54_new/4.999999999999999e-10 , 7.433807325289527e-10 , 1.1052298269905653e-09,  &
                   1.6432131168021894e-09, 2.443065940939191e-09 , 3.6322562975838225e-09,  &
                   5.400298694461532e-09 , 8.028955998727923e-09 , 1.1937142383554189e-08,  &
                   1.774768329877785e-08 , 2.6386571622674677e-08, 3.923053788358319e-08 ,  &
                   5.8326451978805853e-08, 8.671752119563893e-08 , 1.2892826885901822e-07,  &
                   1.916855818962134e-07 , 2.8499073657049155e-07, 4.23713245031476e-07  ,  &
                   6.299605249474363e-07 , 9.366010329994983e-07 , 1.3925023239970815e-06,  &
                   2.0703187953224405e-06, 3.078070205270512e-06 , 4.576356167939073e-06 ,  &
                   6.80395000087189e-06  , 1.0115850671477016e-05, 1.5039856964632177e-05,  &
                   2.2360679774997894e-05, 3.3244997021966576e-05, 4.942738047822476e-05 ,  &
                   7.348672461377988e-05 , 0.0001092572303490903 , 0.00016243943986198265,  &
                   0.00024150869959238707, 0.0003590658280302072 , 0.0005338452365344201 ,  &
                   0.0007937005259840992 , 0.0011800433568293503 , 0.0017544429900314548 ,  &
                   0.0026084382302197402 , 0.003878125444674546  , 0.0057658474678026735 ,  &
                   0.008572439828530724  , 0.012745173198587088  , 0.018949032377148105  ,  &
                   0.028172691138478423  , 0.041886071551668     , 0.06227459710567822   ,  &
                   0.0925874712287292    , 0.13765548437003194   , 0.20466086961524402   ,  &
                   0.30428189434918607   , 0.45239459503319      , 0.6726028508958253    ,  &
                   1.0   /

      data a55/ 1.00000,     2.00000,       3.27000,       &
              4.75850,       6.60000,       8.93450,       &
             11.97030,      15.94950,      21.13490,       &
             27.85260,      36.50410,      47.58060,       &
             61.67790,      79.51340,     101.94420,       &
            130.05080,     165.07920,     208.49720,       &
            262.02120,     327.64330,     407.65670,       &
            504.68050,     621.68000,     761.98390,       &
            929.29430,    1127.68880,    1364.33920,       &
           1645.70720,    1979.15540,    2373.03610,       &
           2836.78160,    3380.99550,    4017.54170,       &
           4764.39320,    5638.79380,    6660.33770,       &
           7851.22980,    9236.56610,   10866.34270,       &
          12783.70000,   15039.30000,   17693.00000,       &
          20119.20876,   21686.49129,   22436.28749,       &
          22388.46844,   21541.75227,   19873.78342,       &
          17340.31831,   13874.44006,   10167.16551,       &
           6609.84274,    3546.59643,    1270.49390,       &
              0.00000,       0.00000   /

      data b55 /0.00000,       0.00000,       0.00000,     &
                0.00000,       0.00000,       0.00000,     & 
                0.00000,       0.00000,       0.00000,     &
                0.00000,       0.00000,       0.00000,     &
                0.00000,       0.00000,       0.00000,     &
                0.00000,       0.00000,       0.00000,     &
                0.00000,       0.00000,       0.00000,     &
                0.00000,       0.00000,       0.00000,     &
                0.00000,       0.00000,       0.00000,     &
                0.00000,       0.00000,       0.00000,     &
                0.00000,       0.00000,       0.00000,     &
                0.00000,       0.00000,       0.00000,     &
                0.00000,       0.00000,       0.00000,     &
                0.00000,       0.00000,       0.00000,     &
                0.00696,       0.02801,       0.06372,     &
                0.11503,       0.18330,       0.27033,     &
                0.37844,       0.51046,       0.64271,     &
                0.76492,       0.86783,       0.94329,     &
                0.98511,       1.00000  /

      data a56/  10.00000,      24.97818,      58.01160,   &
                115.21466,     199.29210,     309.39897,   &
                445.31785,     610.54747,     812.28518,   &
               1059.80882,    1363.07092,    1732.09335,   &
               2176.91502,    2707.68972,    3334.70962,   &
               4068.31964,    4918.76594,    5896.01890,   &
               7009.59166,    8268.36324,    9680.41211,   &
              11252.86491,   12991.76409,   14901.95764,   &
              16987.01313,   19249.15733,   21689.24182,   &
              23845.11055,   25330.63353,   26243.52467,   &
              26663.84998,   26657.94696,   26281.61371,   &
              25583.05256,   24606.03265,   23393.39510,   &
              21990.28845,   20445.82122,   18811.93894,   &
              17139.59660,   15473.90350,   13850.50167,   &
              12294.49060,   10821.62655,    9440.57746,   &
               8155.11214,    6965.72496,    5870.70511,   &
               4866.83822,    3949.90019,    3115.03562,   &
               2357.07879,    1670.87329,    1051.65120,   &
                495.51399,       0.00000,       0.00000 /

      data b56 /0.00000,       0.00000,       0.00000,  &
                0.00000,       0.00000,       0.00000,  &
                0.00000,       0.00000,       0.00000,  &
                0.00000,       0.00000,       0.00000,  &
                0.00000,       0.00000,       0.00000,  &
                0.00000,       0.00000,       0.00000,  &
                0.00000,       0.00000,       0.00000,  &
                0.00000,       0.00000,       0.00000,  &
                0.00000,       0.00000,       0.00000,  &
                0.00462,       0.01769,       0.03821,  &
                0.06534,       0.09834,       0.13659,  &
                0.17947,       0.22637,       0.27660,  &
                0.32929,       0.38343,       0.43791,  &
                0.49162,       0.54361,       0.59319,  &
                0.63989,       0.68348,       0.72391,  &
                0.76121,       0.79545,       0.82679,  &
                0.85537,       0.88135,       0.90493,  &
                0.92626,       0.94552,       0.96286,  &
                0.97840,       0.99223,       1.00000 /

      data a60/  1.7861000000e-01,   1.0805100000e+00,   3.9647100000e+00, &
                 9.7516000000e+00,   1.9816580000e+01,   3.6695950000e+01, &
                 6.2550570000e+01,   9.9199620000e+01,   1.4792505000e+02, &
                 2.0947487000e+02,   2.8422571000e+02,   3.7241721000e+02, &
                 4.7437835000e+02,   5.9070236000e+02,   7.2236063000e+02, &
                 8.7076746000e+02,   1.0378138800e+03,   1.2258877300e+03, &
                 1.4378924600e+03,   1.6772726600e+03,   1.9480506400e+03, &
                 2.2548762700e+03,   2.6030909400e+03,   2.9988059200e+03, &
                 3.4489952300e+03,   3.9616028900e+03,   4.5456641600e+03, &
                 5.2114401700e+03,   5.9705644000e+03,   6.8361981800e+03, &
                 7.8231906000e+03,   8.9482351000e+03,   1.0230010660e+04, &
                 1.1689289750e+04,   1.3348986860e+04,   1.5234111060e+04, &
                 1.7371573230e+04,   1.9789784580e+04,   2.2005564550e+04, &
                 2.3550115120e+04,   2.4468583320e+04,   2.4800548800e+04, &
                 2.4582445070e+04,   2.3849999620e+04,   2.2640519740e+04, &
                 2.0994737150e+04,   1.8957848730e+04,   1.6579413230e+04, &
                 1.4080071030e+04,   1.1753630920e+04,   9.6516996300e+03, &
                 7.7938009300e+03,   6.1769062800e+03,   4.7874276000e+03, &
                 3.6050497500e+03,   2.6059860700e+03,   1.7668328200e+03, &
                 1.0656131200e+03,   4.8226201000e+02,   0.0000000000e+00, &
                 0.0000000000e+00 /  


      data b60/ 0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
                0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
                0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
                0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
                0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
                0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
                0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
                0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
                0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
                0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
                0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
                0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
                0.0000000000e+00,   0.0000000000e+00,   5.0600000000e-03, &
                2.0080000000e-02,   4.4900000000e-02,   7.9360000000e-02, &
                1.2326000000e-01,   1.7634000000e-01,   2.3820000000e-01, &
                3.0827000000e-01,   3.8581000000e-01,   4.6989000000e-01, &
                5.5393000000e-01,   6.2958000000e-01,   6.9642000000e-01, &
                7.5458000000e-01,   8.0463000000e-01,   8.4728000000e-01, &
                8.8335000000e-01,   9.1368000000e-01,   9.3905000000e-01, &
                9.6020000000e-01,   9.7775000000e-01,   9.9223000000e-01, &
                1.0000000000e+00 /


      data a64/1.00000,       3.90000,       8.70000,      &
              15.42000,      24.00000,      34.50000,      &
              47.00000,      61.50000,      78.60000,      &
              99.13500,     124.12789,     154.63770,      &
             191.69700,     236.49300,     290.38000,      &
             354.91000,     431.82303,     523.09300,      &
             630.92800,     757.79000,     906.45000,      &
            1079.85000,    1281.00000,    1515.00000,      &
            1788.00000,    2105.00000,    2470.00000,      &
            2889.00000,    3362.00000,    3890.00000,      &
            4475.00000,    5120.00000,    5830.00000,      &
            6608.00000,    7461.00000,    8395.00000,      &
            9424.46289,   10574.46880,   11864.80270,      &
           13312.58890,   14937.03710,   16759.70700,      &
           18804.78710,   21099.41210,   23674.03710,      &
           26562.82810,   29804.11720,   32627.31640,      &
           34245.89840,   34722.28910,   34155.19920,      &
           32636.50390,   30241.08200,   27101.44920,      &
           23362.20700,   19317.05270,   15446.17090,      &
           12197.45210,    9496.39941,    7205.66992,      &
            5144.64307,    3240.79346,    1518.62134,      &
               0.00000,       0.00000 /

      data b64/0.00000,       0.00000,       0.00000,      &
               0.00000,       0.00000,       0.00000,      &
               0.00000,       0.00000,       0.00000,      &
               0.00000,       0.00000,       0.00000,      &
               0.00000,       0.00000,       0.00000,      &
               0.00000,       0.00000,       0.00000,      &
               0.00000,       0.00000,       0.00000,      &
               0.00000,       0.00000,       0.00000,      &
               0.00000,       0.00000,       0.00000,      &
               0.00000,       0.00000,       0.00000,      &
               0.00000,       0.00000,       0.00000,      &
               0.00000,       0.00000,       0.00000,      &
               0.00000,       0.00000,       0.00000,      &
               0.00000,       0.00000,       0.00000,      &
               0.00000,       0.00000,       0.00000,      &
               0.00000,       0.00000,       0.00813,      &
               0.03224,       0.07128,       0.12445,      &
               0.19063,       0.26929,       0.35799,      &
               0.45438,       0.55263,       0.64304,      &
               0.71703,       0.77754,       0.82827,      &
               0.87352,       0.91502,       0.95235,      &
               0.98511,       1.00000 /
!
! Ultra high troposphere resolution
      data a100/100.00000,     300.00000,     800.00000,   &
               1762.35235,    3106.43596,    4225.71874,   &
               4946.40525,    5388.77387,    5708.35540,   &
               5993.33124,    6277.73673,    6571.49996,   &
               6877.05339,    7195.14327,    7526.24920,   &
               7870.82981,    8229.35361,    8602.30193,   &
               8990.16936,    9393.46399,    9812.70768,   &
              10248.43625,   10701.19980,   11171.56286,   &
              11660.10476,   12167.41975,   12694.11735,   &
              13240.82253,   13808.17600,   14396.83442,   &
              15007.47066,   15640.77407,   16297.45067,   &
              16978.22343,   17683.83253,   18415.03554,   &
              19172.60771,   19957.34218,   20770.05022,   &
              21559.14829,   22274.03147,   22916.87519,   &
              23489.70456,   23994.40187,   24432.71365,   &
              24806.25734,   25116.52754,   25364.90190,   &
              25552.64670,   25680.92203,   25750.78675,   &
              25763.20311,   25719.04113,   25619.08274,   &
              25464.02630,   25254.49482,   24991.06137,   &
              24674.32737,   24305.11235,   23884.79781,   &
              23415.77059,   22901.76510,   22347.84738,   &
              21759.93950,   21144.07284,   20505.73136,   &
              19849.54271,   19179.31412,   18498.23400,   &
              17809.06809,   17114.28232,   16416.10343,   &
              15716.54833,   15017.44246,   14320.43478,   &
              13627.01116,   12938.50682,   12256.11762,   &
              11580.91062,   10913.83385,   10255.72526,   &
               9607.32122,    8969.26427,    8342.11044,   &
               7726.33606,    7122.34405,    6530.46991,   &
               5950.98721,    5384.11279,    4830.01153,   &
               4288.80090,    3760.55514,    3245.30920,   &
               2743.06250,    2253.78294,    1777.41285,   &
               1313.88054,     863.12371,     425.13088,   &
                  0.00000,       0.00000  /


      data b100/0.00000,       0.00000,       0.00000,   &
                0.00000,       0.00000,       0.00000,   &
                0.00000,       0.00000,       0.00000,   &
                0.00000,       0.00000,       0.00000,   &
                0.00000,       0.00000,       0.00000,   &
                0.00000,       0.00000,       0.00000,   &
                0.00000,       0.00000,       0.00000,   &
                0.00000,       0.00000,       0.00000,   &
                0.00000,       0.00000,       0.00000,   &
                0.00000,       0.00000,       0.00000,   &
                0.00000,       0.00000,       0.00000,   &
                0.00000,       0.00000,       0.00000,   &
                0.00000,       0.00000,       0.00000,   &
                0.00052,       0.00209,       0.00468,   &
                0.00828,       0.01288,       0.01849,   &
                0.02508,       0.03266,       0.04121,   &
                0.05075,       0.06126,       0.07275,   &
                0.08521,       0.09866,       0.11308,   &
                0.12850,       0.14490,       0.16230,   &
                0.18070,       0.20009,       0.22042,   &
                0.24164,       0.26362,       0.28622,   &
                0.30926,       0.33258,       0.35605,   &
                0.37958,       0.40308,       0.42651,   &
                0.44981,       0.47296,       0.49591,   &
                0.51862,       0.54109,       0.56327,   &
                0.58514,       0.60668,       0.62789,   &
                0.64872,       0.66919,       0.68927,   &
                0.70895,       0.72822,       0.74709,   &
                0.76554,       0.78357,       0.80117,   &
                0.81835,       0.83511,       0.85145,   &
                0.86736,       0.88286,       0.89794,   &
                0.91261,       0.92687,       0.94073,   &
                0.95419,       0.96726,       0.97994,   &
                0.99223,       1.00000  /

      data a104/           &
  1.8827062944e-01,   7.7977549145e-01,   2.1950593583e+00, &
  4.9874566624e+00,   9.8041418997e+00,   1.7019717163e+01, &
  2.7216579591e+01,   4.0518628401e+01,   5.6749646818e+01, &
  7.5513868331e+01,   9.6315093333e+01,   1.1866706195e+02, &
  1.4216835396e+02,   1.6653733709e+02,   1.9161605772e+02, &
  2.1735580129e+02,   2.4379516604e+02,   2.7103771847e+02, &
  2.9923284173e+02,   3.2856100952e+02,   3.5922338766e+02, &
  3.9143507908e+02,   4.2542117983e+02,   4.6141487902e+02, &
  4.9965698106e+02,   5.4039638379e+02,   5.8389118154e+02, &
  6.3041016829e+02,   6.8023459505e+02,   7.3366009144e+02, &
  7.9099869949e+02,   8.5258099392e+02,   9.1875827946e+02, &
  9.8990486716e+02,   1.0664204381e+03,   1.1487325074e+03, &
  1.2372990044e+03,   1.3326109855e+03,   1.4351954993e+03, &
  1.5456186222e+03,   1.6644886848e+03,   1.7924597105e+03, &
  1.9302350870e+03,   2.0785714934e+03,   2.2382831070e+03, &
  2.4102461133e+03,   2.5954035462e+03,   2.7947704856e+03, &
  3.0094396408e+03,   3.2405873512e+03,   3.4894800360e+03, &
  3.7574811281e+03,   4.0460585279e+03,   4.3567926151e+03, &
  4.6913848588e+03,   5.0516670674e+03,   5.4396113207e+03, &
  5.8573406270e+03,   6.3071403487e+03,   6.7914704368e+03, &
  7.3129785102e+03,   7.8745138115e+03,   8.4791420557e+03, &
  9.1301611750e+03,   9.8311179338e+03,   1.0585825354e+04, &
  1.1398380836e+04,   1.2273184781e+04,   1.3214959424e+04, &
  1.4228767429e+04,   1.5320029596e+04,   1.6494540743e+04, &
  1.7758482452e+04,   1.9118430825e+04,   2.0422798801e+04, &
  2.1520147587e+04,   2.2416813461e+04,   2.3118184510e+04, &
  2.3628790785e+04,   2.3952411814e+04,   2.4092209011e+04, &
  2.4050892106e+04,   2.3830930156e+04,   2.3434818358e+04, &
  2.2865410898e+04,   2.2126326004e+04,   2.1222420323e+04, &
  2.0160313690e+04,   1.8948920926e+04,   1.7599915822e+04, &
  1.6128019809e+04,   1.4550987232e+04,   1.2889169132e+04, &
  1.1164595563e+04,   9.4227665517e+03,   7.7259097899e+03, &
  6.1538244381e+03,   4.7808126007e+03,   3.5967415552e+03, &
  2.5886394104e+03,   1.7415964865e+03,   1.0393721271e+03, &
  4.6478852032e+02,   7.0308342481e-13,   0.0000000000e+00    / 




      data b104/           &
  0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
  0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
  0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
  0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
  0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
  0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
  0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
  0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
  0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
  0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
  0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
  0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
  0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
  0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
  0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
  0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
  0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
  0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
  0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
  0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
  0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
  0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
  0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
  0.0000000000e+00,   0.0000000000e+00,   0.0000000000e+00, &
  0.0000000000e+00,   0.0000000000e+00,   1.5648447298e-03, &
  6.2617046389e-03,   1.4104157933e-02,   2.5118187415e-02, &
  3.9340510972e-02,   5.6816335609e-02,   7.7596328431e-02, &
  1.0173255472e-01,   1.2927309709e-01,   1.6025505622e-01, &
  1.9469566981e-01,   2.3258141217e-01,   2.7385520518e-01, &
  3.1840233814e-01,   3.6603639170e-01,   4.1648734767e-01, &
  4.6939496013e-01,   5.2431098738e-01,   5.8071350676e-01, &
  6.3803478105e-01,   6.9495048840e-01,   7.4963750338e-01, &
  7.9975208897e-01,   8.4315257576e-01,   8.8034012292e-01, &
  9.1184389721e-01,   9.3821231526e-01,   9.6000677644e-01, &
  9.7779792223e-01,   9.9216315122e-01,   1.0000000000e+00     /

  if(uniform_z_spacing) then
     call uniform_height_spacing(km, ks, ak, bk)
  else if(flexible_grid) then
     call flexible_grid_generator(km, ak, bk)
  else
      select case (km)

       case (24)

          ks = 5     
          do k=1,km+1
            ak(k) = a24(k)
            bk(k) = b24(k)
          enddo

       case (26)
                
          ks = 7
          do k=1,km+1
            ak(k) = a26(k)     
            bk(k) = b26(k)     
          enddo

        case (32)
!         ks = 11              ! John Wilson's setup
          ks = 13              ! high-res trop_32 setup
          do k=1,km+1
            !ak(k) = a32(k)
            !bk(k) = b32(k)
            ak(k) = a32w(k)
            bk(k) = b32w(k)
          enddo


        case (47)
          ks = 27       ! high-res trop-strat
          do k=1,km+1
            ak(k) = a47(k)
            bk(k) = b47(k)
          enddo

        case (48)
#ifdef HI_48
          ks = 30
#else
          ks = 28
#endif
          do k=1,km+1
            ak(k) = a48(k)
            bk(k) = b48(k)
          enddo

#ifdef HOT_JUPITER
        case (50)
          ks = 1
          do k=1,km+1
            ak(k) = a50(k)
            bk(k) = b50(k)
          enddo
#endif

        case (52)
          ks = 35         ! pint = 223
          do k=1,km+1
            ak(k) = a52(k)
            bk(k) = b52(k)
          enddo

        case (54)
          ks = 18         ! pint =  222.9332
          do k=1,km+1
            !ak(k) = a54(k)
            !bk(k) = b54(k)
            ak(k) = a54_new(k)
            bk(k) = b54_new(k)
          enddo

        case (55)
          ks = 41
          do k=1,km+1
            ak(k) = a55(k)
            bk(k) = b55(k)
          enddo

        case (56)
          ks = 26
          do k=1,km+1
            ak(k) = a56(k)
            bk(k) = b56(k)
          enddo

        case (60)
          ks = 37
          do k=1,km+1
            ak(k) = a60(k)
            bk(k) = b60(k)
          enddo


        case (64)
          ks = 46
          do k=1,km+1
            ak(k) = a64(k)
            bk(k) = b64(k)
          enddo

        case (100)
          ks = 38
          do k=1,km+1
            ak(k) = a100(k)
            bk(k) = b100(k)
          enddo

        case (104)
          ks = 73
          do k=1,km+1
            ak(k) = a104(k)
            bk(k) = b104(k)
          enddo


#ifndef TEST_GWAVES
        case (10)
!--------------------------------------------------
! Pure sigma-coordinate with uniform spacing in "z"
!--------------------------------------------------
!
         pt = 2000.           ! model top pressure (pascal)
!        pt =  100.           ! 1 mb
         press(1) = pt
         press(km+1) = p0
         dlnp = (log(p0) - log(pt)) / real(km)

            lnpe = log(press(km+1))
         do k=km,2,-1
            lnpe = lnpe - dlnp
            press(k) = exp(lnpe)
         enddo

! Search KS
            ks = 0
         do k=1,km
            if(press(k) >= pc) then
               ks = k-1
               goto 123
            endif
         enddo
123   continue

         if(ks /= 0) then
            do k=1,ks
               ak(k) = press(k)
               bk(k) = 0.
            enddo                                                
          endif                                                

             pint = press(ks+1)
          do k=ks+1,km                                        
             ak(k) =  pint*(press(km)-press(k))/(press(km)-pint)               
             bk(k) = (press(k) - ak(k)) / press(km+1)          
          enddo                                                
             ak(km+1) = 0. 
             bk(km+1) = 1.                                     
                                                              
!         do k=2,km
!            bk(k) = real(k-1) / real(km)
!            ak(k) = pt * ( 1. - bk(k) )
!         enddo

             ak(km+1) = 0.
             bk(km+1) = 1.
#endif

        case default

#ifdef TEST_GWAVES
!--------------------------------------------------
! Pure sigma-coordinate with uniform spacing in "z"
!--------------------------------------------------
          call gw_1d(km, 1000.E2, ak, bk, ptop, 10.E3, pt1)

            ks = 0
          pint = ak(1)
#else
      call uniform_spacing(km, ks, ak, bk)
#endif
      end select
 endif ! uniform_vert_spacing
      ptop = ak(1)

 end subroutine set_eta

 subroutine uniform_spacing(km, ks, ak, bk)
  !----------------------------------------------------------------
  ! Sigma-coordinate with uniform spacing in sigma and ptop = 1 mb
  !----------------------------------------------------------------
  integer,  intent(in) :: km   ! vertical dimension
  integer,  intent(out):: ks   ! number of pure p layers
  real, intent(out):: ak(km+1)
  real, intent(out):: bk(km+1)
  real :: pt, pint
  integer :: k

         pt = 100.
! One pressure layer
         ks = 1
         pint = pt + 0.5*1.E5/real(km)

         ak(1) = pt
         bk(1) = 0.
         ak(2) = pint
         bk(2) = 0.
 
          do k=3,km+1
             bk(k) = real(k-2) / real(km-1)
             ak(k) = pint - bk(k)*pint
          enddo
          ak(km+1) = 0.
          bk(km+1) = 1.

 end subroutine uniform_spacing

  subroutine uniform_height_spacing(km, ks, ak, bk)
  !----------------------------------------------------------------
  ! Sigma-coordinate with uniform spacing in sigma and ptop = 1 mb
  !----------------------------------------------------------------
  integer,  intent(in) :: km   ! vertical dimension
  integer,  intent(out):: ks   ! number of pure p layers
  real, intent(out):: ak(km+1)
  real, intent(out):: bk(km+1)
  integer :: k
  real :: x
          do k=1,km+1
             x = -uniform_z_factor*(km-k+1)/(km+1)
             bk(k) = exp(x)
             ak(k) = 0
          enddo

 end subroutine uniform_height_spacing

 subroutine flexible_grid_generator(km, ak, bk)
   !=============================================================================
   ! Description - Generates coefficients log spaced between pbot and plin
   !               and then linearly spaced between plin and pup. Linear spacing
   !               in upper atmosphere preferred for RT calculations where log
   !               spacing leads to many levels needing small tau approx.
   !               Translated from Elsie Lee's python script
   !=============================================================================

   !=============================================================================
   ! Input arguments
   !=============================================================================
   integer, intent(in) :: km 

   !=============================================================================
   ! Output arguments
   !=============================================================================
   real, intent(out) :: ak(km+1) 
   real, intent(out) :: bk(km+1)

   !============================================================================
   ! Local variables
   !============================================================================
   integer :: k
   real    :: log_pk(km+1)
   
   !=============================================================================
   ! Main body begins here
   !=============================================================================

   ! Generate log spaced pressures between pbot and pup for bk 
   do k=1, km+1
      log_pk(k) = log(pup) + real((k-1))/real(km) * log(pbot/pup)
      bk(k) = exp(log_pk(k))/pbot
   end do
   
   ! Generate linearly spaced pressures between pup and plin for ak
   do k=1, km+1
      ak(k) = pup + real((k-1))/real(km) * (plin - pup)
   end do

   ! Ensure that ak(km+1) and bk(km+1) are 0 and 1 respectively
   ak(km+1) = 0.
   bk(km+1) = 1.
   
 end subroutine flexible_grid_generator

 subroutine get_eta_level(npz, p_s, pf, ph, ak, bk, pscale)
  integer, intent(in) :: npz    
  real, intent(in)  :: p_s            ! unit: pascal
  real, intent(in)  :: ak(npz+1)
  real, intent(in)  :: bk(npz+1)
  real, intent(in), optional :: pscale
  real, intent(out) :: pf(npz)
  real, intent(out) :: ph(npz+1)
  integer k

  ph(1) = ak(1)               
  do k=2,npz+1
     ph(k) = ak(k) + bk(k)*p_s
  enddo                           
   
  if ( present(pscale) ) then
      do k=1,npz+1
         ph(k) = pscale*ph(k)
      enddo
  endif 

  if( ak(1) > 1.E-8 ) then   
     pf(1) = (ph(2) - ph(1)) / log(ph(2)/ph(1))
  else
     pf(1) = (ph(2) - ph(1)) * kappa/(kappa+1.)
  endif

  do k=2,npz
     pf(k) = (ph(k+1) - ph(k)) / log(ph(k+1)/ph(k))
  enddo

 end subroutine get_eta_level



 subroutine compute_dz(km, ztop, dz)

  integer, intent(in):: km
  real,   intent(in):: ztop        ! try 50.E3
  real,   intent(out):: dz(km)
!------------------------------
  real ze(km+1), dzt(km)
  integer k


! ztop = 30.E3
  dz(1) = ztop / real(km) 
  dz(km) = 0.5*dz(1)

  do k=2,km-1
     dz(k) = dz(1)
  enddo

! Top:
  dz(1) = 2.*dz(2)

  ze(km+1) = 0.
  do k=km,1,-1
     ze(k) = ze(k+1) + dz(k)
  enddo

  if ( gid==0 ) then
       write(*,*) 'Hybrid_z:  dz, zm'
       do k=1,km
          dzt(k) = 0.5*(ze(k)+ze(k+1)) / 1000.
          write(*,*) k, dz(k), dzt(k)
       enddo
  endif

 end subroutine compute_dz

 subroutine compute_dz_L32(km, ztop, dz)

  integer, intent(in):: km
  real,   intent(out):: dz(km)
  real,   intent(out):: ztop        ! try 50.E3
!------------------------------
  real dzt(km)
  real ze(km+1)
  real dz0, dz1, dz2
  real z0, z1, z2
  integer k, k0, k1, k2, n

!-------------------
        k2 =  8
        z2 = 30.E3
!-------------------
        k1 = 21
        z1 = 10.0E3
!-------------------
        k0 = 2
        z0 = 0.
!       dz0 = 80.   ! meters
        dz0 = 75.   ! meters
!-------------------
! Treat the surface layer as a special layer
        ze(1) = z0
        dz(1) = dz0

        ze(2) = dz(1)
          dz0 = 1.5*dz0
        dz(2) = dz0     

        ze(3) = ze(2) + dz(2)

        dz1 = 2.*(z1-ze(3) - k1*dz0) / (k1*(k1-1))

        do k=k0+1,k0+k1
           dz(k) = dz0 + (k-k0)*dz1
           ze(k+1) = ze(k) + dz(k)
        enddo

        dz0 = dz(k1+k0)
        dz2 = 2.*(z2-ze(k0+k1+1)-k2*dz0) / (k2*(k2-1))

        do k=k0+k1+1,k0+k1+k2
           dz(k) = dz0 + (k-k0-k1)*dz2
           ze(k+1) = ze(k) + dz(k)
        enddo

        dz(km) = 2.*dz(km-1)
        ztop = ze(km) + dz(km)
        ze(km+1) = ze(km) + dz(km)

        call zflip (dz, 1, km)

        ze(km+1) = 0.
        do k=km,1,-1
           ze(k) = ze(k+1) + dz(k)
        enddo

        if ( gid==0 ) then
           write(*,*) 'Hybrid_z:  dz, zm'
           do k=1,km
              dzt(k) = 0.5*(ze(k)+ze(k+1)) / 1000.
              write(*,*) k, dz(k), dzt(k)
           enddo
        endif

 end subroutine compute_dz_L32


 subroutine set_hybrid_z(is, ie, js, je, ng, km, ztop, dz, rgrav, hs, ze, delz)

 integer,  intent(in):: is, ie, js, je, ng, km
 real, intent(in):: rgrav, ztop
 real, intent(in):: dz(km)       ! Reference vertical resolution for zs=0
 real, intent(in):: hs(is-ng:ie+ng,js-ng:je+ng)
 real, intent(out), optional:: delz(is:ie,js:je,km)
 real, intent(out)::   ze(is:ie,js:je,km+1)
! local
 integer ntimes
 real zint
 real:: z1(is:ie,js:je)
 real:: z(km+1)
 real sig
 integer ks(is:ie,js:je)
 integer i, j, k, ks_min, kint

 z(km+1) = 0.
 do k=km,1,-1
    z(k) = z(k+1) + dz(k)
 enddo

  do j=js,je
     do i=is,ie
        ze(i,j,   1) = ztop 
        ze(i,j,km+1) = hs(i,j) * rgrav 
     enddo
  enddo

 do k=2,km
   do j=js,je
      do i=is,ie
         ze(i,j,k) = z(k)
      enddo
   enddo
 enddo

! Set interface:
#ifdef USE_CONST_ZINT
  zint = 8.5E3
  ntimes = 4
  kint = 2
  do k=2,km
     if ( z(k)<=zint ) then
          kint = k
          exit
     endif
  enddo

  if ( gid==0 ) write(*,*) 'Z_coord interface set at k=',kint, ' ZE=', z(kint)

  do j=js,je
     do i=is,ie
        do k=kint+1,km
           sig = 1. - min(1., z(k)/z(kint))
           ze(i,j,k) = z(k) + ze(i,j,km+1)*sig
        enddo
!--------------------------------------
! Apply vertical smoother locally to dz
!--------------------------------------
        call sm1_edge(is, ie, js, je, km, i, j, ze, ntimes)
    enddo
  enddo
#else
! ZINT is a function of local terrain
  ntimes = 5
  do j=js,je
     do i=is,ie
        z1(i,j) = 1.75*max(0.0, ze(i,j,km+1)) + z(km-2)
     enddo
  enddo

   ks_min = km
   do j=js,je
      do i=is,ie
         do k=km,2,-1
            if ( z(k)>=z1(i,j) ) then
                 ks(i,j) = k
                 ks_min = min(ks_min, k)
                 go to 555
            endif
        enddo
555     continue
      enddo
   enddo

  do j=js,je
     do i=is,ie
        kint = ks(i,j) + 1
        do k=kint,km
           sig = 1. - min(1., z(k)/z1(i,j))
           ze(i,j,k) = z(k) + ze(i,j,km+1)*sig
        enddo
!--------------------------------------
! Apply vertical smoother locally to dz
!--------------------------------------
        call sm1_edge(is, ie, js, je, km, i, j, ze, ntimes)
    enddo
  enddo
#endif

  if ( present(delz) ) then
  do k=1,km
     do j=js,je
        do i=is,ie
           delz(i,j,k) = ze(i,j,k+1) - ze(i,j,k)
           if ( delz(i,j,k) > 0. ) then
                write(*,*) 'Error in set_hybrid_z:', k,j,i, delz(i,j,k)
!               stop
           endif
        enddo
     enddo
  enddo
  endif

  end subroutine set_hybrid_z


  subroutine sm1_edge(is, ie, js, je, km, i, j, ze, ntimes)
  integer, intent(in):: is, ie, js, je, km
  integer, intent(in):: ntimes, i, j
  real, intent(inout):: ze(is:ie,js:je,km+1)
! local:
  real, parameter:: df = 0.25
  real dz(km)
  real flux(km+1)
  integer k, n, k1, k2

      k2 = km-1
      do k=1,km
         dz(k) = ze(i,j,k+1) - ze(i,j,k)
      enddo

   do n=1,ntimes
      k1 = 2 + (ntimes-n)

      flux(k1  ) = 0.
      flux(k2+1) = 0.
      do k=k1+1,k2
         flux(k) = df*(dz(k) - dz(k-1))
      enddo

      do k=k1,k2
         dz(k) = dz(k) - flux(k) + flux(k+1)
      enddo
   enddo

   do k=km,1,-1
      ze(i,j,k) = ze(i,j,k+1) - dz(k)
   enddo

  end subroutine sm1_edge

  subroutine gw_1d(km, p0, ak, bk, ptop, ztop, pt1)
  integer, intent(in):: km
  real,    intent(in):: p0, ztop
  real,    intent(inout):: ptop
  real,    intent(inout):: ak(km+1), bk(km+1)
  real, intent(out):: pt1(km)
! Local
  logical:: isothermal
  real, dimension(km+1):: ze, pe1, pk1
  real, dimension(km):: dz1
  real t0, n2, s0
  integer  k

! Set up vertical coordinare with constant del-z spacing:
       isothermal = .false.
       t0 = 300.

       if ( isothermal ) then
            n2 = grav**2/(cp_air*t0)
       else
            n2 = 0.0001
       endif

       s0 = grav*grav / (cp_air*n2) 

       ze(km+1) = 0.
       do k=km,1,-1
          dz1(k) = ztop / real(km)
           ze(k) = ze(k+1) + dz1(k)
       enddo

! Given z --> p
       do k=1,km+1
          pe1(k) = p0*( (1.-s0/t0) + s0/t0*exp(-n2*ze(k)/grav) )**(1./kappa)
       enddo

       ptop = pe1(1) 
!      if ( gid==0 ) write(*,*) 'GW_1D: computed model top (pa)=', ptop

! Set up "sigma" coordinate 
       ak(1) = pe1(1)
       bk(1) = 0.
       do k=2,km
          bk(k) = (pe1(k) - pe1(1)) / (pe1(km+1)-pe1(1))  ! bk == sigma
          ak(k) =  pe1(1)*(1.-bk(k)) 
       enddo                                                
       ak(km+1) = 0.
       bk(km+1) = 1.

       do k=1,km+1
          pk1(k) = pe1(k) ** kappa
       enddo

! Compute volume mean potential temperature with hydrostatic eqn:
       do k=1,km
          pt1(k) = grav*dz1(k) / ( cp_air*(pk1(k+1)-pk1(k)) )
       enddo

  end subroutine gw_1d



  subroutine zflip(q, im, km)
  integer, intent(in):: im, km
  real, intent(inout):: q(im,km)
!---
  integer i, k
  real qtmp

    do i = 1, im
       do k = 1, (km+1)/2
          qtmp = q(i,k)
          q(i,k) = q(i,km+1-k)
          q(i,km+1-k) = qtmp
       end do                                              
    end do                                                
                                                              
  end subroutine zflip   

end module fv_eta_mod
